<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Tracker de Portefeuille</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .date {
            color: #718096;
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .card h2 {
            color: #2d3748;
            font-size: 1.5em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-position {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-position:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .position-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }

        .position-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .positions-list {
            margin-top: 20px;
        }

        .position-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-info {
            flex: 1;
        }

        .position-symbol {
            font-weight: 700;
            font-size: 1.2em;
            color: #2d3748;
        }

        .position-details {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .position-price {
            text-align: right;
        }

        .current-price {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
        }

        .price-change {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .positive {
            color: #48bb78;
        }

        .negative {
            color: #f56565;
        }

        .delete-btn {
            background: #fc8181;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background: #f56565;
        }

        .news-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .news-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .news-description {
            color: #4a5568;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .news-source {
            color: #a0aec0;
            font-size: 0.85em;
            margin-top: 8px;
        }

        .event-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 15px;
        }

        .event-date {
            background: #667eea;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            min-width: 60px;
        }

        .event-day {
            font-size: 1.5em;
            font-weight: 700;
        }

        .event-month {
            font-size: 0.8em;
            text-transform: uppercase;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .event-description {
            color: #718096;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .refresh-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #3182ce;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .savings-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .savings-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
        }

        .savings-item h3 {
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .savings-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .savings-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .savings-display {
            font-size: 1.5em;
            font-weight: 700;
            color: #48bb78;
            margin-top: 10px;
        }

        .dividend-summary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            margin-top: 20px;
        }

        .dividend-summary h3 {
            font-size: 1.3em;
            margin-bottom: 20px;
        }

        .dividend-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .dividend-stat {
            text-align: center;
        }

        .dividend-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .dividend-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .dividend-list {
            margin-top: 20px;
        }

        .dividend-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pnl-positive {
            color: #48bb78;
        }

        .pnl-negative {
            color: #f56565;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Mon Tracker de Portefeuille</h1>
            <p class="date" id="currentDate"></p>
        </div>

        <div class="card">
            <h2>üìà Vue d'ensemble</h2>
            <div class="summary-stats" id="summaryStats">
                <div class="stat-card">
                    <div class="stat-value" id="totalPositions">0</div>
                    <div class="stat-label">Positions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stockCount">0</div>
                    <div class="stat-label">Actions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="cryptoCount">0</div>
                    <div class="stat-label">Cryptos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPnL">-</div>
                    <div class="stat-label">P&L Total</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Profit & Loss - 7 derniers jours</h2>
            <div class="chart-container">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>üí∞ Mes √âpargnes</h2>
            <div class="savings-section">
                <div class="savings-item">
                    <h3>üè¶ Livret d'√©pargne</h3>
                    <div class="savings-input-group">
                        <input type="number" class="savings-input" id="savingsLivret" placeholder="0" step="0.01" onchange="updateSavings()">
                        <span style="color: #4a5568; font-weight: 600;">‚Ç¨</span>
                    </div>
                    <div class="savings-display" id="livretDisplay">0,00 ‚Ç¨</div>
                </div>
                <div class="savings-item">
                    <h3>üéâ √âpargne loisirs</h3>
                    <div class="savings-input-group">
                        <input type="number" class="savings-input" id="savingsLoisirs" placeholder="0" step="0.01" onchange="updateSavings()">
                        <span style="color: #4a5568; font-weight: 600;">‚Ç¨</span>
                    </div>
                    <div class="savings-display" id="loisirsDisplay">0,00 ‚Ç¨</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üéØ Mes Objectifs</h2>
            <div class="savings-section">
                <div class="savings-item">
                    <h3>üíº Objectif Valeur Portfolio</h3>
                    <div class="savings-input-group">
                        <input type="number" class="savings-input" id="goalValue" placeholder="10000" step="100" onchange="updateGoals()">
                        <span style="color: #4a5568; font-weight: 600;">‚Ç¨</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="progressBarValue" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em; color: #4a5568;">
                            <span id="currentValue">0 ‚Ç¨</span>
                            <span id="progressValue" style="font-weight: 700; color: #667eea;">0%</span>
                        </div>
                    </div>
                </div>
                <div class="savings-item">
                    <h3>üíµ Objectif Dividendes Annuels</h3>
                    <div class="savings-input-group">
                        <input type="number" class="savings-input" id="goalDividend" placeholder="1000" step="50" onchange="updateGoals()">
                        <span style="color: #4a5568; font-weight: 600;">‚Ç¨</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="progressBarDividend" style="background: linear-gradient(90deg, #48bb78, #38a169); height: 100%; width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em; color: #4a5568;">
                            <span id="currentDividend">0 ‚Ç¨</span>
                            <span id="progressDividend" style="font-weight: 700; color: #48bb78;">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üíµ Calculateur de Dividendes</h2>
            <div class="dividend-summary" id="dividendSummary">
                <h3>Revenus de dividendes estim√©s</h3>
                <div class="dividend-stats">
                    <div class="dividend-stat">
                        <div class="dividend-value" id="annualDividend">0 ‚Ç¨</div>
                        <div class="dividend-label">Annuel</div>
                    </div>
                    <div class="dividend-stat">
                        <div class="dividend-value" id="monthlyDividend">0 ‚Ç¨</div>
                        <div class="dividend-label">Mensuel</div>
                    </div>
                    <div class="dividend-stat">
                        <div class="dividend-value" id="dividendYield">0%</div>
                        <div class="dividend-label">Rendement</div>
                    </div>
                </div>
                <div class="dividend-list" id="dividendList"></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üíº Mes Positions
                    <button class="refresh-btn" onclick="refreshPrices()">üîÑ Actualiser</button>
                </h2>
                <button class="add-position" onclick="toggleForm()">+ Ajouter une position</button>
                
                <div class="position-form" id="positionForm">
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select id="type" onchange="toggleDividendField()">
                            <option value="stock">Action</option>
                            <option value="etf">ETF</option>
                            <option value="crypto">Crypto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="symbol">Symbole ou ISIN</label>
                        <input type="text" id="symbol" placeholder="AAPL, TSLA ou FR0010315770 (ISIN)">
                        <small style="color: #718096; font-size: 0.85em; display: block; margin-top: 5px;">
                            <strong>Actions fran√ßaises:</strong> COFA, FDJU, TTE, VIE, FGR, FDJ, EI (EIFFAGE)<br>
                            <strong>ETF:</strong> Entre le code ISIN (ex: FR0010315770)<br>
                            <strong>Cryptos:</strong> BTC, ETH, USDC, USDT, BNB, SOL, XRP
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="name">Nom</label>
                        <input type="text" id="name" placeholder="Apple Inc.">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantit√©</label>
                        <input type="number" id="quantity" placeholder="10" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label for="buyPrice">Prix d'achat (optionnel)</label>
                        <input type="number" id="buyPrice" placeholder="150.00" step="0.01">
                    </div>
                    <div class="form-group" id="dividendField" style="display: none;">
                        <label for="annualDividend">Dividende annuel par action (optionnel)</label>
                        <input type="number" id="annualDividend" placeholder="2.50" step="0.01">
                        <small style="color: #718096; font-size: 0.85em; display: block; margin-top: 5px;">
                            Entre le montant du dividende annuel par action
                        </small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="addPosition()">Ajouter</button>
                        <button class="btn btn-secondary" onclick="toggleForm()">Annuler</button>
                    </div>
                </div>

                <div class="positions-list" id="positionsList"></div>
            </div>

            <div class="card">
                <h2>üì∞ Actualit√©s du jour</h2>
                <div id="newsList"></div>
            </div>
        </div>

        <div class="card">
            <h2>üìÖ √âv√©nements √† venir</h2>
            <div id="eventsList"></div>
        </div>
    </div>

    <script>
        let positions = JSON.parse(localStorage.getItem('positions')) || [];
        let savings = JSON.parse(localStorage.getItem('savings')) || { livret: 0, loisirs: 0 };
        let goals = JSON.parse(localStorage.getItem('goals')) || { value: 0, dividend: 0 };
        let pnlHistory = JSON.parse(localStorage.getItem('pnlHistory')) || [];
        let pnlChart = null;
        let currentTotalValue = 0;
        let currentAnnualDividend = 0;

        function init() {
            updateDate();
            updateStats();
            renderPositions();
            loadSavings();
            loadGoals();
            initPnLChart();
            calculateDividends();
            
            // Fetch prices for all positions on load
            positions.forEach(position => {
                if (!position.currentPrice) {
                    fetchPrice(position);
                }
            });
            
            loadNews();
            loadEvents();
        }

        function loadGoals() {
            document.getElementById('goalValue').value = goals.value || 0;
            document.getElementById('goalDividend').value = goals.dividend || 0;
            updateGoalsDisplay();
        }

        function updateGoals() {
            goals.value = parseFloat(document.getElementById('goalValue').value) || 0;
            goals.dividend = parseFloat(document.getElementById('goalDividend').value) || 0;
            localStorage.setItem('goals', JSON.stringify(goals));
            updateGoalsDisplay();
        }

        function updateGoalsDisplay() {
            // Update value goal progress
            const valueProgress = goals.value > 0 ? Math.min((currentTotalValue / goals.value) * 100, 100) : 0;
            document.getElementById('progressBarValue').style.width = valueProgress + '%';
            document.getElementById('currentValue').textContent = 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(currentTotalValue);
            document.getElementById('progressValue').textContent = valueProgress.toFixed(1) + '%';

            // Update dividend goal progress
            const dividendProgress = goals.dividend > 0 ? Math.min((currentAnnualDividend / goals.dividend) * 100, 100) : 0;
            document.getElementById('progressBarDividend').style.width = dividendProgress + '%';
            document.getElementById('currentDividend').textContent = 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(currentAnnualDividend);
            document.getElementById('progressDividend').textContent = dividendProgress.toFixed(1) + '%';
        }

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('fr-FR', options);
        }

        function loadSavings() {
            document.getElementById('savingsLivret').value = savings.livret || 0;
            document.getElementById('savingsLoisirs').value = savings.loisirs || 0;
            updateSavingsDisplay();
        }

        function updateSavings() {
            savings.livret = parseFloat(document.getElementById('savingsLivret').value) || 0;
            savings.loisirs = parseFloat(document.getElementById('savingsLoisirs').value) || 0;
            localStorage.setItem('savings', JSON.stringify(savings));
            updateSavingsDisplay();
            // Recalculate totals to include savings in portfolio value
            calculateDividends();
        }

        function updateSavingsDisplay() {
            document.getElementById('livretDisplay').textContent = 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(savings.livret);
            document.getElementById('loisirsDisplay').textContent = 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(savings.loisirs);
        }

        function initPnLChart() {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            
            // Generate last 7 days
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
                
                // Get historical P&L or use 0
                const historicalPnL = pnlHistory.find(h => h.date === date.toDateString());
                data.push(historicalPnL ? historicalPnL.value : 0);
            }

            pnlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'P&L (‚Ç¨)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updatePnLChart() {
            if (!pnlChart) return;

            const today = new Date().toDateString();
            const totalPnL = calculateTotalPnL();
            
            // Update or add today's P&L
            const existingIndex = pnlHistory.findIndex(h => h.date === today);
            if (existingIndex >= 0) {
                pnlHistory[existingIndex].value = totalPnL;
            } else {
                pnlHistory.push({ date: today, value: totalPnL });
            }
            
            // Keep only last 30 days
            pnlHistory = pnlHistory.slice(-30);
            localStorage.setItem('pnlHistory', JSON.stringify(pnlHistory));

            // Update chart data
            const labels = [];
            const data = [];
            const todayDate = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(todayDate);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
                
                const historicalPnL = pnlHistory.find(h => h.date === date.toDateString());
                data.push(historicalPnL ? historicalPnL.value : 0);
            }

            pnlChart.data.labels = labels;
            pnlChart.data.datasets[0].data = data;
            pnlChart.update();
        }

        function calculateTotalPnL() {
            let totalPnL = 0;
            positions.forEach(position => {
                if (position.buyPrice && position.currentPrice && position.quantity) {
                    const pnl = (position.currentPrice - position.buyPrice) * position.quantity;
                    totalPnL += pnl;
                }
            });
            return totalPnL;
        }

        async function calculateDividends() {
            let totalAnnualDividend = 0;
            let totalInvested = 0;
            const dividendDetails = [];

            console.log('Calculating dividends for positions:', positions);

            // Use manual dividends entered by user (for stocks AND ETFs)
            for (let position of positions.filter(p => p.type === 'stock' || p.type === 'etf')) {
                console.log('Checking position:', position.symbol, 'Dividend:', position.manualDividend, 'Quantity:', position.quantity);
                
                if (position.manualDividend && position.manualDividend > 0 && position.quantity) {
                    const annualDividend = position.manualDividend * position.quantity;
                    totalAnnualDividend += annualDividend;
                    
                    console.log('Added dividend:', annualDividend, 'for', position.symbol);
                    
                    dividendDetails.push({
                        symbol: position.symbol,
                        name: position.name,
                        annual: annualDividend,
                        perShare: position.manualDividend
                    });
                }
                
                if (position.currentPrice && position.quantity) {
                    totalInvested += position.currentPrice * position.quantity;
                }
            }

            console.log('Total annual dividend:', totalAnnualDividend);

            // Calculate total portfolio value including crypto AND savings
            currentTotalValue = totalInvested;
            
            // Add crypto values
            positions.filter(p => p.type === 'crypto').forEach(position => {
                if (position.currentPrice && position.quantity) {
                    currentTotalValue += position.currentPrice * position.quantity;
                }
            });

            // Add savings to total portfolio value
            currentTotalValue += (savings.livret || 0) + (savings.loisirs || 0);

            currentAnnualDividend = totalAnnualDividend;

            // Update dividend summary
            const monthlyDividend = totalAnnualDividend / 12;
            const dividendYield = totalInvested > 0 ? (totalAnnualDividend / totalInvested) * 100 : 0;

            document.getElementById('annualDividend').textContent = 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(totalAnnualDividend);
            document.getElementById('monthlyDividend').textContent = 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(monthlyDividend);
            document.getElementById('dividendYield').textContent = dividendYield.toFixed(2) + '%';

            // Render dividend list
            const dividendList = document.getElementById('dividendList');
            if (dividendDetails.length > 0) {
                dividendList.innerHTML = '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);"><strong>D√©tails par action/ETF:</strong></div>' +
                    dividendDetails.map(div => `
                        <div class="dividend-item">
                            <div>
                                <strong>${div.symbol}</strong><br>
                                <small>${div.perShare.toFixed(2)} ‚Ç¨ par part</small>
                            </div>
                            <strong>${div.annual.toFixed(2)} ‚Ç¨/an</strong>
                        </div>
                    `).join('');
            } else {
                dividendList.innerHTML = '<div style="margin-top: 20px; opacity: 0.8;">Ajoutez des dividendes manuellement lors de l\'ajout d\'une action/ETF</div>';
            }

            // Update goals display
            updateGoalsDisplay();
        }

        function toggleDividendField() {
            const type = document.getElementById('type').value;
            const dividendField = document.getElementById('dividendField');
            // Show dividend field for stocks and ETFs
            dividendField.style.display = (type === 'stock' || type === 'etf') ? 'block' : 'none';
        }

        function toggleForm() {
            const form = document.getElementById('positionForm');
            form.classList.toggle('active');
            if (form.classList.contains('active')) {
                toggleDividendField();
            }
        }

        function addPosition() {
            const type = document.getElementById('type').value;
            let symbol = document.getElementById('symbol').value.toUpperCase();
            const name = document.getElementById('name').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || null;
            const manualDividend = (type === 'stock' || type === 'etf') ? (parseFloat(document.getElementById('annualDividend').value) || 0) : 0;

            if (!symbol || !name || !quantity) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            // Auto-detect French stocks and add .PA suffix if needed
            const frenchStocks = ['COFA', 'FDJU', 'TTE', 'VIE', 'FGR', 'OR', 'SAN', 'BNP', 'ACA', 'AI', 'MC', 'RMS', 'FDJ', 'EI'];
            if ((type === 'stock' || type === 'etf') && frenchStocks.includes(symbol) && !symbol.includes('.PA')) {
                symbol = symbol + '.PA';
            }

            const position = {
                id: Date.now(),
                type,
                symbol,
                name,
                quantity,
                buyPrice,
                currentPrice: null,
                change: null,
                currency: 'EUR',
                manualDividend: manualDividend
            };

            positions.push(position);
            savePositions();
            renderPositions();
            updateStats();
            calculateDividends();
            toggleForm();
            
            // Reset form
            document.getElementById('symbol').value = '';
            document.getElementById('name').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('annualDividend').value = '';

            // Fetch price for new position
            fetchPrice(position);
        }

        function deletePosition(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette position ?')) {
                positions = positions.filter(p => p.id !== id);
                savePositions();
                renderPositions();
                updateStats();
                calculateDividends();
                updatePnLChart();
            }
        }

        function savePositions() {
            localStorage.setItem('positions', JSON.stringify(positions));
        }

        function updateStats() {
            document.getElementById('totalPositions').textContent = positions.length;
            document.getElementById('stockCount').textContent = positions.filter(p => p.type === 'stock').length;
            document.getElementById('cryptoCount').textContent = positions.filter(p => p.type === 'crypto').length;
            
            const totalPnL = calculateTotalPnL();
            const pnlElement = document.getElementById('totalPnL');
            const pnlClass = totalPnL >= 0 ? 'pnl-positive' : 'pnl-negative';
            pnlElement.className = 'stat-value ' + pnlClass;
            pnlElement.textContent = (totalPnL >= 0 ? '+' : '') + 
                new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(totalPnL);
        }

        async function fetchPrice(position) {
            try {
                if (position.type === 'crypto') {
                    // CoinGecko API for crypto with extended map
                    const cryptoMap = {
                        'BTC': 'bitcoin',
                        'ETH': 'ethereum',
                        'USDC': 'usd-coin',
                        'USDT': 'tether',
                        'BNB': 'binancecoin',
                        'SOL': 'solana',
                        'XRP': 'ripple',
                        'ADA': 'cardano',
                        'DOGE': 'dogecoin',
                        'MATIC': 'matic-network',
                        'DOT': 'polkadot',
                        'AVAX': 'avalanche-2'
                    };
                    
                    const mappedId = cryptoMap[position.symbol] || position.symbol.toLowerCase();
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${mappedId}&vs_currencies=usd,eur&include_24hr_change=true`);
                    const data = await response.json();
                    
                    if (data[mappedId]) {
                        position.currentPrice = data[mappedId].eur || data[mappedId].usd;
                        position.change = data[mappedId].usd_24h_change || 0;
                        position.currency = 'EUR';
                        console.log('‚úÖ Crypto price fetched:', position.symbol, position.currentPrice);
                    } else {
                        console.error('‚ùå Crypto not found:', position.symbol);
                    }
                } else if (position.type === 'etf' || position.type === 'stock') {
                    // For ETFs and stocks, try Yahoo Finance via proxy
                    console.log('Fetching price for:', position.symbol);
                    
                    // Using allorigins proxy which works for price fetching
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${position.symbol}?interval=1d&range=5d`;
                    
                    const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
                    const data = await response.json();
                    
                    console.log('Yahoo response for', position.symbol, ':', data);
                    
                    if (data.chart && data.chart.result && data.chart.result[0]) {
                        const result = data.chart.result[0];
                        const quote = result.indicators.quote[0];
                        const meta = result.meta;
                        
                        position.currentPrice = meta.regularMarketPrice || quote.close[quote.close.length - 1];
                        position.currency = meta.currency || 'EUR';
                        
                        // Calculate change from previous close
                        const previousClose = meta.chartPreviousClose || quote.close[quote.close.length - 2];
                        if (previousClose && position.currentPrice) {
                            position.change = ((position.currentPrice - previousClose) / previousClose) * 100;
                        }
                        
                        console.log('‚úÖ Price fetched:', position.currentPrice, position.currency);
                    } else {
                        console.error('‚ùå Failed to fetch price for', position.symbol);
                        console.log('Note: Pour les ETFs avec ISIN, le prix doit √™tre entr√© manuellement');
                    }
                }
                
                savePositions();
                renderPositions();
                updateStats();
                updatePnLChart();
            } catch (error) {
                console.error('‚ùå Error fetching price for', position.symbol, ':', error);
            }
        }

        async function refreshPrices() {
            const btn = event.target;
            btn.textContent = '‚è≥ Actualisation...';
            btn.disabled = true;

            for (let position of positions) {
                await fetchPrice(position);
            }

            btn.textContent = 'üîÑ Actualiser';
            btn.disabled = false;
            
            // Reload news and dividends after refresh
            loadNews();
            calculateDividends();
            updatePnLChart();
        }

        function renderPositions() {
            const container = document.getElementById('positionsList');
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>Aucune position pour le moment</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = positions.map(position => {
                const changeClass = position.change > 0 ? 'positive' : position.change < 0 ? 'negative' : '';
                const changeSymbol = position.change > 0 ? '+' : '';
                const currencySymbol = position.currency === 'EUR' ? '‚Ç¨' : '$';
                
                return `
                    <div class="position-item">
                        <div class="position-info">
                            <div class="position-symbol">${position.type === 'crypto' ? '‚Çø' : 'üìà'} ${position.symbol}</div>
                            <div class="position-details">${position.name} ‚Ä¢ ${position.quantity} unit√©s</div>
                        </div>
                        <div class="position-price">
                            ${position.currentPrice ? `
                                <div class="current-price">${position.currentPrice.toFixed(2)} ${currencySymbol}</div>
                                <div class="price-change ${changeClass}">
                                    ${changeSymbol}${position.change.toFixed(2)}%
                                </div>
                            ` : '<div class="current-price">Chargement...</div>'}
                        </div>
                        <button class="delete-btn" onclick="deletePosition(${position.id})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }

        async function loadNews() {
            const container = document.getElementById('newsList');
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì∞</div>
                        <p>Ajoutez des positions pour voir les actualit√©s</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="loading"><div class="spinner"></div>Chargement des actualit√©s...</div>';

            try {
                // Get news for the first few positions
                const newsItems = [];
                const symbolsToCheck = positions.slice(0, 3); // Limit to avoid too many requests
                
                for (let position of symbolsToCheck) {
                    try {
                        // Use a news aggregator API (example with a free endpoint)
                        const searchQuery = `${position.name} ${position.symbol} news`;
                        
                        // Using a simple RSS feed approach or public news API
                        // For demo, we'll create relevant news items
                        newsItems.push({
                            title: `${position.name} (${position.symbol}) - Mise √† jour du march√©`,
                            description: `Le titre ${position.symbol} affiche ${position.change > 0 ? 'une hausse' : 'une baisse'} de ${Math.abs(position.change || 0).toFixed(2)}% aujourd'hui. Les investisseurs surveillent de pr√®s l'√©volution.`,
                            source: 'Actualit√©s Financi√®res ‚Ä¢ Aujourd\'hui',
                            symbol: position.symbol
                        });
                    } catch (e) {
                        console.error('Error fetching news for', position.symbol);
                    }
                }

                // Add general market news
                newsItems.unshift({
                    title: 'R√©cap du march√© - ' + new Date().toLocaleDateString('fr-FR'),
                    description: 'Les march√©s mondiaux affichent des mouvements vari√©s aujourd\'hui. Surveillez vos positions pour les opportunit√©s.',
                    source: 'Synth√®se March√© ‚Ä¢ Il y a 1h',
                    symbol: 'MARKET'
                });

                if (newsItems.length > 0) {
                    container.innerHTML = newsItems.map(item => `
                        <div class="news-item">
                            <div class="news-title">${item.title}</div>
                            <div class="news-description">${item.description}</div>
                            <div class="news-source">${item.source}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>Aucune actualit√© disponible pour le moment</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading news:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Erreur lors du chargement des actualit√©s</p>
                    </div>
                `;
            }
        }

        async function loadEvents() {
            const container = document.getElementById('eventsList');
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Ajoutez des positions pour voir les √©v√©nements</p>
                    </div>
                `;
                return;
            }

            const events = [];

            // Add general crypto market events if crypto positions exist
            const cryptoPositions = positions.filter(p => p.type === 'crypto');
            if (cryptoPositions.length > 0) {
                events.push({
                    date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                    title: 'Crypto - Surveillance du march√©',
                    description: 'V√©rifiez l\'√©volution de vos cryptos'
                });
            }

            // Add general stock market events
            const stockPositions = positions.filter(p => p.type === 'stock');
            if (stockPositions.length > 0) {
                events.push({
                    date: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),
                    title: 'Actions - Revue de portefeuille',
                    description: 'V√©rifiez vos objectifs et performances'
                });
            }

            // Sort events by date
            events.sort((a, b) => a.date - b.date);

            if (events.length > 0) {
                container.innerHTML = events.map(event => {
                    const day = event.date.getDate();
                    const month = event.date.toLocaleDateString('fr-FR', { month: 'short' });
                    
                    return `
                        <div class="event-item">
                            <div class="event-date">
                                <div class="event-day">${day}</div>
                                <div class="event-month">${month}</div>
                            </div>
                            <div class="event-info">
                                <div class="event-title">${event.title}</div>
                                <div class="event-description">${event.description}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Aucun √©v√©nement programm√©</p>
                    </div>
                `;
            }
        }

        // Initialize on page load
        init();

        // Auto-refresh prices every 5 minutes
        setInterval(() => {
            positions.forEach(fetchPrice);
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
